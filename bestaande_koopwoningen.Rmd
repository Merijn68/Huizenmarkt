---
title: "Ontwikkeling huizenmarkt in Nederland"
author:
- Merijn van Miltenburg
date: "25/02/2021"
output: 
    html_document:
      code_folding: hide
      toc: true
      toc_depth: 2
      number_sections: true
bibliography: bibliography.bib
csl: apa-6th-edition.csl
nocite: | 
  @KennethGopalGerardvanLeeuwenDavidOmtzigt2019,
  @OldfordR.J.MacKay2000,
  @Research2020,
  @Vogt2018,
  @KennethGopalGerardvanLeeuwenDavidOmtzigt2020,
  @LeonGroenemeijerKennethGopal2020,
  @MinisterievanBinnenlandseZakenenKoninkrijksrelaties2021,
  @CBS2016,
  @CBS2020,
  @CBS2020a,
  CBS2020b,
  @Groot2018,
  @Foreman2014
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

# Inleiding


De volksbank is het moederbedrijf van ASN, SNS, BLG en Regiobank. Als de vierde bank van Nederland, financiert de volksbank hypotheken, beheert ze spaargeld en biedt de bank klanten een betaalrekening.

Binnen de afdeling Financial Markets, hebben de macro economen van de Volksbank als taak de toestand in de economie te monitoren en toe te lichten aan directie en beleidsmakers. Een belangrijk onderdeel daarvan heeft betrekking met de ontwikkeling van de hypotheekmarkt in Nederland. De huizenmarkt is een belangrijke factor in de beleidsontwikkeling van de bank, met betrekking tot de hypotheekproductie.

De huizenprijzen en aantallen verkochte woningen zijn belangrijke indicatoren voor de ontwikkeling van de hypotheekmarkt.

Voor deze analyse is de PPDAC cyclus ( Problem, Plan, Data, Analysis, and Conclusions) gevolgd. Een methode voor het uitvoeren van statististch onderzoek [OldfordR.J.MacKay2000]. De opbouw van dit verslag volgt deze cyclus. In de volgende paragraaf wordt eerst de probleemstelling nader toegelicht. Vervolgens is in de planningsfase een literatuurstudie uitgevoerd om de belangrijkste factoren te bepalen die nodig zijn om de vraagstelling te beantwoorden. De data benodigd voor dit onderzoek is daarna verzameld en vervolgens geanalyseerd. Op basis daarvan worden tot slot een aantal conclusies getrokken. Deze cyclus is een aantal keer doorlopen - op basis van de uitkomsten. Dit komt terug in de probleemstelling en de uitwerking van deze casus.

# Probleemstelling

Uit het overleg met de macro economen is de vraag naar voren gekomen of een beter voorspellend model kan worden ontwikkeld voor de huizenmarkt in Nederland.

Is het mogelijk om modellen te ontwikkelen die de huizenprijs op middellange termijn voorspelt en het aantal transacties op de huizenmarkt op middellange termijn voorspelt?"

Vanuit de Volksbank is in het verleden al eerder statistisch onderzoek gedaan naar deze vebanden. 
Data werd hierbij verzameld via Datascope (Refinitiv) en geanalyseerd in Excel.

Voor de huizenprijzen is eerder gekeken naar een verband tussen huizenprijzen en de werkgelegenheid, lonen, GDP en rente. Hieruit is een eenvoudig model ontwikkeld waarbij met name het verband met GDP wordt gebruikt om de ontwikkeling van de huizenprijzen te voorspellen. Voor het aantal transacties op de lange termijn wordt een verband verondersteld met het aantal huishoudens. op kortere termijn spelen economische groei, rentestanden en evt. regelgeving ook een rol.

In deze exploratie wil ik kijken naar mogelijke factoren die effect hebben op de marktprijs. Het is in deze fase nog niet de ambitie om ook daadwerkelijk een alternatief model te ontwikkelen voor het voorspellen van de marktprijzen en aantal transacties. 

Welke factoren spelen een belangrijke rol in het bepalen van de huizenprijzen en transactie volumes op een termijn van 5 tot 10 jaar?

Aanvullend zijn er een aantal vragen geformuleerd waar mogelijk door middel van exploratie iets meer over te weten kunnen komen:

1. Nederland heeft een van de hoogste persoonlijke schulden (hypotheeklast) in de wereld. Wat zijn de gevolgen voor de hypotheekmarkt van het gewijzigde beleid? Heeft dit effect op de huizenprijzen?

1. Hoe ontwikkeld de krapte op de huizenmarkt zich, op termijn? Momenteel zijn er ambiteuze plannen om ergens tussen de 75.000 en 100.000 woningen per jaar te gaan bouwen. Het aanbod aan huizen wordt dus groter - terwijl op termijn verwacht wordt dat de bevolking weer gaat krimpen. Kunnen we hier een voorspelling van maken?

1. Hoe zit het met de bevolkingsgroei? Welk deel van de aanwas in Nederland komt door migratie? Hoe zit dat regionaal? Is er nog sprake van verstedelijking na corona?  Stroomt het platteland leeg - en de randstad vol? Welk effect heeft dit op de huizenprijzen? 

1. Zien we demografisch verdeeld verschillen waar mensen willen wonen? Verhuizen gezinnen met kinderen naar het platteland, en ouderen weer naar de stad? Het aantal huishoudens dat uit 1 persoon bestaat is erg gegroeid in de loop der tijd - en zal (denk ik) nog wel doorstijgen met de vergrijzing. Betekent dit dat er meer mensen naar de stad willen verhuizen?

1. Hoe afhankelijk is de huizenmarkt van de stand van de economie? Gaan huizenprijzen alleen omhoog tijdens de groeifase van de economie? 


De eerste deelvraag van dit onderzoek gaat in op de vraag in hoeverre de huizenprijzen wordt bepaald door vraag en aanbod. 

Daarna wordt verder ingegaan op de factoren die op langere termijn de huizenprijzen beinvloeden en wordt gekeken of hier voorspellende waarde in zit.

Vervolgens wordt gekeken naar de transactievolumes. Transactievolumes hebben waarschijnlijk een direct verband met het aantal huishoudens. Hierbij is gekeken of er seizoensinvloeden of trendmatigheden in de transactie volumes te ontdekken zijn. 

Ten slot wordt kort ingegaan op de vraag of er regionaal verschillen zijn in de ontwikkeling van de huizenprijzen. 


# Plan

Om in ieder geval een begin te maken met het beantwoorden van deze vragen ben ik in gesprek gegaan met de specialisten bij de Volksbank. Aanvullend heb ik een korte literatuurstudie gedaan naar de factoren die op lange termijn de prijsstelling zouden beinvloeden. 

In eerste instantie richt het onderzoek zich op de vraag en aanbod op de woningmarkt in Nederland. Het CBS publiceert vrij veel over de prijsonwikkeling van bestaande woningen, nieuwe woningen en de stand van de economie. De Socrates modellen sluiten goed aan bij deze vraagstelling [zie @KennethGopalGerardvanLeeuwenDavidOmtzigt2020]. 


```{r}
# # install.packages("kableExtra")
# library(kableExtra)
# library(here)
# 
# 
# tbl_img <- data.frame(
#   name = c("kableExtra 1", "kableExtra 2"),
#   Marktprijs  = "",
#   Transacties = ""
# )
# 
# green <- here("images","green.png")
# red <- here("images","red.png")
# 
# tbl_img %>%
#   kbl(booktabs = T) %>%
#   kable_paper(full_width = F) %>%
#   column_spec(2, image = spec_image(
#     c(green, red), 50, 50)) %>%
#   column_spec(3, image = spec_image(
#     c(red, green), 50, 50))
```

Op langere termijn is de woningmarkt een markt van vraag en aanbod.
Vraag en aanbod worden bepaald door:

:::::: {.columns}
::: {.column width="48%" data-latex="{0.48\textwidth}"}
Vraag woningen:

*	Aantal huishoudens
*	Demografie (omvang en samenstelling huishoudens)
* (Arbeids)migratie
:::
::: {.column width="4%" data-latex="{0.04\textwidth}"}
\ 
:::
:::::: {.column width="48%" data-latex="{0.48\textwidth}"}
Aanbod woningen:

* Woningvoorraad
* Nieuwbouw / Sloop 
* Bouwkosten
* Beschikbaarheid bouwlocaties
* Ruimtelijke ordeningbeleid
:::
::::::
\newline

Daarna is verder ingegaan op de factoren die van invloed zijn bij de prijsonwikkeling op de woningmarkt. Hierbij kan een onderscheidt gemaakt worden in factoren die direct de prijsontwikkeling beinvloeden - en factoren die meer aanduiden of er sprake is van oververhitting [@Groot2018].

:::::: {.columns}
::: {.column width="48%" data-latex="{0.48\textwidth}"}
Indicatoren Huizenprijzen

*	Gem. huizenprijzen (prijsindex)
* Besteedbaar Inkomen
* Particulier vermogen
* Werkloosheid
* Rentestanden
* Financiering hypotheek of eigen geld
* Fiscale behandeling, subsidies
* Toegang tot krediet
* Voorkeuren van kopers
* Percentage huur / koop woningen
* Consumentenvertrouwen

Oververhitting huizenmarkt

*	Gem. huurprijzen (berekenen verhouding koop/huur)
*	Aantal woningen dat te koop staat 
* Gem. duur dat een woning te koop staat
* Verschil tussen aanbodprijs en transactieprijs
* Aanbod huizen

:::
::: {.column width="4%" data-latex="{0.04\textwidth}"}
\ 
:::
:::::: {.column width="48%" data-latex="{0.48\textwidth}"}
Het aantal transacties wordt met name bepaald door het aantal huishoudens. Daarnaast kan door krapte op de woningmarkt een schaarste ontstaan waardoor de woningmarkt 'op slot' geraakt. Tijdelijk zou prijsinelastisiteit er voor kunnen zorgen dat consumenten geen nieuwe woning betrekken omdat zij de huizen te duur vinden. Het consumentenvertrouwen speelt hierbij een belangrijke rol.

Indicatoren aantal transacties

* Aanbod huizen
* Hypotheek rente
* Toegang tot krediet
* Werkloosheid
* Consumentenvertrouwen
* verschil aanbodprijs en transactieprijs
*	Aantal dagen aangeboden

:::
::::

# Data

De gewenste informatie is opgevraagd bij de statistici (via Reuters Datastream) en later aangevuld met open data van het CBS (Statline). 

Voor het inlezen van de (spreadsheet) Reutersdata zijn een aantal functies ontwikkeld. Om de data van het CBS gemakkelijker in te kunnen lezen is een routine ontwikkeld die aan de hand van metadata de gevraagde data inleest. Routines voor het lezen en opschonen van de data, zijn opgeslagen in seperate R files. 

De data die via die routines is gegenereerd wordt tussentijds opgeslagen in Rdata formaat - en kan voor de analyse hier direct worden ingelezen. Op deze wijze is een scheiding aangebracht tussen de data-acquisitie en de analyse van de resultaten.

Ter beperking van de omvang van dit onderzoek is een selecties gemaakt op basis van de beschikbare data. 

Voor de indicatoren over de huizenprijzen zal ik mij alleen beperken tot 
het besteedbaar inkomen, de rente standen, particulier vermogen en werkloosheid en het consumenenvertrouwen.

Gegevens over de verhouding tussen huur en koopprijzen, het aantal te koop staande huizen, de gem. tijd dat een woning te koop staat en de prijsverschillen tussen aanbodprijs en transactieprijs zeggen iets over de mate van oververhitting van de markt (zie @Groot2018). Ik beschik echter niet over voldoende data om hier een tijdsanalyse over uit te voeren.

Voor de indicatoren over het aantal transacties beperk ik mij tot een tijdreeksanalyse van de transacties zelf. Langere termijn afhankelijkheden van de economie, het consumentenvertrouwen en het aantal huishoudens zullen er zeker zijn maar zijn vanwege de beperkte tijd voor dit onderzoek niet verder meegenomen.


```{r}

library (tidyverse)          # standard tidyverse packages
library (here)               # reletive paths for files
library (lubridate)          # Work with dates
library (reshape2)           # for easy melting wide format data
library (knitr)              # for outputting data tables
library (kableExtra)         # Nice layout options for data tables
library (viridis)            # Nicer colors for plots

library (forcats)            # for handling categorical data


library (forecast)           # Time series forecasting
library (timetk)             # Time series forecasting
library (fpp2)               # Time series forecasting

#install.packages("fpp2")

library (zoo)                # handling time series

library (ggpubr)             # Mix multiple graphs
library (cowplot)            # for alignin multiple plots 

library (urca)               # for time serries analyses
 
library(sjPlot)              # For printing model output

library(sf)                  # spacial data for maps
#install.packages("sjPlot")

# Loading the datasets

dfs<-list.files(here("data","tidy"), pattern = "*.Rdata")
for(d in dfs) {
  load(file= here("data","tidy",d ))
}

```

# Analyse 

## Prijsontwikkeling woningmarkt

Prijzen van koopwoningen zijn de laatste jaren erg sterk toegenomen. We zien kleine verschillen per type woning. Waarbij met name appartementen de laatste tijd releatief duurder zijn geworden.


```{r}
prijsindex_type_woning %>%
  filter(type_woning != "Totaal woningen") %>%
  filter(type_woning != "EGW") %>%
  ggplot(aes(x=date, y=prijsindex_type_woning)) +
  geom_line(aes(color = type_woning)) +
  theme_minimal() +
  facet_wrap(~ type_woning) +
  labs(
    title = "Prijsindex Bestaande Koopwoningen (PBK)",
    y = "",
    x = '',
    color = 'Type woning'
    ) +
  theme(legend.position = "none")
  
```

###  Vraag naar woningen

Bij de factoren die de vraag naar woningen bepalen kijken we naar de ontwikkeling van het aantal huishoudens en de samenstelling van de huishoudens. Nederlanders worden steeds ouder, en gezinnen worden kleiner. Ontwikkeling leidt mogelijk tot een verschuiving in de vraag - van eensgezinswoningen naar kleinere woningen. 

Dit verband is niet duidelijk terug te zien in de data. Het aantal 65+ ers is wel flink gegroeid - maar de verhoudingen tussen de groepen blijft redelijk stabiel.

```{r}
df <- 
  bevolking %>%
  select (date, kl_20_jaar, v20_40_jaar, v40_65_jaar, v65_80_jaar, gd_80_jaar) %>%
  melt (id = c('date')) %>%
  mutate (year = factor(year(date))) %>%
  mutate (variable = factor (variable) ) 

levels(df$variable) = c('< 20 jaar', 
                        '20-40 jaar', 
                        '40-65 jaar', 
                        '65-80 jaar', 
                        '> 80 jaar')
df %>% 
  mutate (value = value / 1000) %>%
  filter (date == as.Date("2020-01-01") |
            date == as.Date("2010-01-01") |
            date == as.Date("2000-01-01") |
            date == as.Date("1990-01-01") |
            date == as.Date("1980-01-01") ) %>%
  ggplot( aes( x = variable, y = value, fill = year) ) +
  geom_bar(color = "black",  stat="identity", position="dodge") +
  scale_fill_brewer()  + 
  theme_minimal() +
  coord_flip() +
  labs(
    title = "Bevolkingssamenstelling",
    y = "(x 1000)",
    x = ''
    ) + 
    guides(fill = guide_legend(reverse = TRUE))

```

```{r}
bevolking %>% 
  select (date, kl_20_jaar, v20_40_jaar, v40_65_jaar, v65_80_jaar, gd_80_jaar) %>% 
  filter (date >= as.Date("1970-01-01")) %>% 
  melt (id = c('date')) %>% 
  mutate ( variable = factor(variable), 
           variable = factor(variable, levels = rev(levels(variable)))) %>% 
  mutate (value = value / 1000) %>% 
  ggplot ( aes( x = date, y = value, fill = variable) ) +
  geom_area(color = "darkgray", stat = "identity") +
  scale_fill_brewer(palette = "Set2", 
                    name = "Leeftijdsgroep",
                    direction = -1, labels = c("> 80 jaar", 
                                                          "65 > 80 jaar", 
                                                          "40 > 65 jaar",
                                                          "20 > 40 jaar",
                                                          "< 20 jaar"))  + 
  theme_minimal() +
  labs(
    title = "Bevolkingsgroei",
    subtitle = "1950 tot 2020",
    y = "Aantal (x 1000)",
    x = '',
    caption = "Bron: CBS, Bevolking; kerncijfers"
    )  
  
  
```

De groei van de Nederlandse bevolking wordt in de laatste jaren steeds meer bepaald door migratie. Het geboorteoverschot (aantal nieuw geborenen -/- aantal sterfgevallen is nog nooit zo laag geweest).
Mogelijk zien we hierdoor regionaal een sterkere vraag naar woningen in de steden.

```{r}

bevolking %>%
  select (date, geboorteoverschot, migratiesaldo) %>% 
  filter (date >= as.Date("1970-01-01")) %>% 
  melt (id = c('date')) %>% 
  mutate (value = value / 1000) %>% 
  drop_na %>% 
  ggplot(aes (x = date, y=value, fill = variable)) +
  geom_bar(stat="identity") +
  theme_minimal() +
  scale_fill_brewer(palette = "Dark2") +
  labs(
    title = "Bevolkingsgroei",
    y = "Aantal (x 1000)",
    x = ''
    ) 
    
```

Het CBS maakt regelmatig een prognose van de verwachte groei. Hier zien we dat deze trand zich de aankomende jaren voortzet. De groei van met name eenspersoonshuishoudens gaat de aankomende jaren nog zo door. De laatste prognoses zijn overigens van 2019.


```{r}

aantal_hh <- 
  bevolking %>% 
  select (date,
            eenpersoonshuishoudens,
            meerpersoonshuishoudens) %>% 
  melt(id = c('date')) %>% 
  set_names ('date','type_huishouden', 'aantal')
  
prognose_hh <-
  prognose_huishoudens_2019 %>% 
  select (date,
            eenpersoonshuishoudens,
            meerpersoonshuishoudens) %>% 
  melt(id = c('date')) %>% 
  set_names ('date','type_huishouden', 'prognose') %>% 
  mutate(prognose = prognose / 1000)

aantal_hh %>% 
  full_join(prognose_hh, by = c("date", "type_huishouden")) %>% 
  melt (id = c('date','type_huishouden')) %>% 
  filter( date >= as.Date("1970-01-01")) %>%
  filter( date <= as.Date("2040-01-01")) %>% 
  drop_na() %>% 
  ggplot(aes (x = date)) +
  geom_line(aes(y=value,  color = type_huishouden, linetype = variable )) +
  theme_minimal() +
  scale_color_brewer(palette = "Accent") +
  labs(
    title = "Prognose huishoudens",
    y = "Aantal (x 1000)",
    x = ''
    ) 

```

### Aanbod van woningen

Wanneer we een wat langere termijn trend kijken naar het aantal gerealiseerde nieuwbouwhuizen zien we dat het aantal nieuwbouwhuizen eigenlijk nu niet bijzonder hoog is. Ondanks dat er meer dan 70.000 huizen bijgebouwd wordt per jaar is dat vergeleken met de totale woningvoorraad eigenlijk niet bijzonder veel. Wel opvallend is dat de laatste jaren er duidelijk meer huizen onttrokken worden aan de woningvoorraad. Mogelijk geeft dit aan dat de ruimte voor nieuwbouw schaarser wordt. We zagen al dat de woningvoorraad lange termijn tred houdt met het aantal huishoudens. 


```{r}

voorraad_woningen %>%
  select(date,
         nieuwbouw,
         overige_toevoegingen,
         sloop,
         Overige_onttrekking,
         correctie
         ) %>%
  mutate (sloop = - sloop ) %>% 
  mutate (Overige_onttrekking = - Overige_onttrekking) %>% 
  mutate (correctie = - correctie) %>% 
  filter( date >= as.Date("1970-01-01")) %>% 
  melt (id = c('date')) %>% 
  mutate (value = value / 1000) %>% 
  ggplot(aes(x=date, y = value, fill = variable )) +
  geom_bar(stat="identity") +
  geom_hline(yintercept  = 0, color = "steelblue") +
  theme_minimal() +
  labs ( title = "Ontwikkelingen woningvoorraad",
         y = "Aantal (x 1000)",
         x = "Jaar") + 
    guides(fill = guide_legend(title = ''))

```

### Samenhang Vraag en aanbod


```{r}

#82235NED CBS Aantal Woningen
#Aantal huishoudens: NLHSTOTP Thomson Reuters

# Tidy data 
df <- 
  aantal_huishoudens_per_jaar %>%
  full_join(voorraad_woningen, by = c("date" = "date")) %>%
  select (date, 
          aantal_huishoudens, 
          voorraad) %>%
  set_names('date',
            'huishoudens',
            'woningvoorraad' ) %>%
  mutate(te_kort = (woningvoorraad - huishoudens)) %>%
  filter(date > as.Date("2000-01-01")) %>%
  melt(id = c('date'))

# Line plot
lp<- 
  df %>%
  filter (variable != 'te_kort') %>%
  ggplot(aes (x = date)) +
  geom_line(aes(y=value, color = variable)) +
  labs(
    title = "Aantal huishoudens vs voorraad woningen",
    y = "Aantal (x 1000)",
    x = '',
    color = ''
    ) 

# Bar plot
bp <- 
  df %>%
  filter (variable == 'te_kort') %>%
  ggplot(aes (x = date)) +
  geom_bar(stat = "identity" , 
           aes(y = value, color = variable, fill = variable )) +
  labs ( y = "Te kort (x 1000)",
         x = "",
         color = "", fill = "") +
  theme( axis.text.x = element_blank(),
         axis.ticks = element_blank()) 
  

ggarrange(lp, bp,  
          heights = c(2, 0.7),
          ncol = 1, nrow = 2, align = "v"
          )

```

In bovenstaande grafiek zien we dat het aantal woningen al decenia lang gelijke tred houdt met het aantal woningen. Er is daarbij een klein tekort zichtbaar. Dit is veel kleiner dan het gerapporteerde tekort van 331.000 woningen [CBS2020b]. De prognose van het aantal huishoudens geeft een voortzetting van deze trend aan. 

Er is in de media veel aandacht voor of de bouwplannen wel realiseerbaar zijn. Mogelijk kan door regelgeving (PFAS, ruimtelijke ordening) de groei van het aantal huizen in de toekomst de groei van de bevolking niet bijhouden waardoor het tekort nog verder oploopt. 

Dit zou verder onderzocht kunnen worden. In deze exploratieve studie wordt hier niet verder op ingegaan. De voorlopige conclusie is dan ook dat er een constante relatie is tussen vraag en aanbod op de huizenmarkt voor Nederland als geheel. 

De voorzichtige conclusie is daarom dat er geen invloed is aangetoond van een verschuiving in vraag en aanbod op de prijsvorming in de huizenmarkt in Nederland.


### Indicatoren Huizenprijzen

*	Gem. huizenprijzen (prijsindex)
* Besteedbaar Inkomen
* Particulier vermogen
* Werkloosheid
* Rentestanden
* Financiering hypotheek of eigen geld
* Fiscale behandeling, subsidies
* Toegang tot krediet
* Voorkeuren van kopers
* Percentage huur / koop woningen
* Consumentenvertrouwen

Vanwege de (structurele) te korten op de woningmarkt lijken huizen prijzen in belangrijke mate beinvloed te worden door de financieringsmogelijkheden van de kopers. De rente is historisch laag, de inkomens zijn gestegen en het eigen vermogen is gegroeit. De fiscale behandeling en regelgeving speelt hier een belangrijke rol, zowel ruimte scheppend - verruimen van de leenmogelijkheden van tweeverdieners, als beperkend - beperking aftrekbaarheid tot 100% financiering.


```{r}

# De percentuale wijzingen zijn hier gecumuleerd. Is dit correct?

lp_prijzen <-
  prijsindex_woningen_lt %>% 
  filter(date >= as.Date('1995-01-01')) %>% 
  ggplot(aes(x = date)) +
  geom_line(aes( y = huisprijsindex), color = 'steelblue') +
  theme_minimal() +
  labs(
    title = "huizenprijzen",
    y = "",
    x = ""
  ) 


lp_gdp <-
  gdp_lt %>% 
  filter(date >= as.Date('1995-01-01')) %>% 
  ggplot( aes(x=date, y=gdp_index)) +
    geom_line(color = 'steelblue') +
    theme_minimal() +
    labs(
      title = "Ontwikkeling trend BBP (Bruto Binnenlands Product)",
      y = "Trend",
      x = ''
      ) 


lp_rente <-
  hypotheek_rente %>%
  filter(period >= as.Date("1995-01-01")) %>% 
  ggplot( aes(x=period, y=hypotheek_rente)) +
  geom_line(color = 'steelblue')  +
  theme_minimal() +
  labs(
    title = "Hypotheekrente",
    y = "gemiddelde rente",
    x = ''
    ) 


# Werkgelegenheid
lp_werkgelegenheid <-
  werkgelegenheid_lt %>% 
  filter (date >= as.Date('1995-01-01')) %>% 
  ggplot(aes(x = period, y = werkgelegenheid)) +
  geom_line(color = 'steelblue') +
  theme_minimal() +
  labs(
    title = "Werkgelegenheid",
    y = "(x 1000)",
    x = ''
  ) 

# Inkomen
lp_inkomen <-
inkomen_lt %>% 
  filter (date >= as.Date('1995-01-01')) %>% 
  ggplot(aes(x = period, y = inkomen)) +
  geom_line(color = 'steelblue') +
  theme_minimal() +
  labs(
    title = "Inkomen",
    y = "(x 1000)",
    x = ''
  ) 

lp_conf <- 
  consumenten_vertrouwen_lt_q %>% 
  filter (date >= as.Date('1995-01-01')) %>% 
  mutate(pos = ifelse(consumer_conf >= 0,consumer_conf, 0)) %>% 
  mutate(neg = ifelse(consumer_conf < 0,consumer_conf, 0)) %>% 
  ggplot(aes(x = date)) +
  geom_area(aes(y = pos), fill = 'steelblue')  +
  geom_area(aes(y = neg), fill = 'indianred2')  +
  geom_hline (yintercept = 0) +
  theme_minimal() +
  labs(
    title = "Consumenten vertrouwen indicator",
    y = "",
    x = ""
  ) 

ggarrange(lp_prijzen, lp_gdp, lp_rente,lp_inkomen, lp_werkgelegenheid,lp_conf,
          ncol = 1, nrow = 6, align = "v"
          )
```

Over de vermogens van huishoudens is er helaas niet een langere termijn tijdsreeks beschikbaar.

```{r}

df_vermogen <-
  vermogen %>% 
  filter(kenmerk_huishouden == "Particuliere huishoudens") %>%
  filter(vermogensbestanddeel == 'Vermogen exclusief eigen woning' )

inkomen %>%
  filter(kenmerk_huishouden == "Particuliere huishoudens")  %>% 
  select (date, besteedbaar_inkomen ) %>% 
  left_join( df_vermogen, by = (c('date')) ) %>% 
  select (date, besteedbaar_inkomen, mediaan_vermogen  ) %>% 
  melt (id = c('date')) %>%
  ggplot( aes(x=date, y=value, color = variable )) +
  geom_line() +
  theme_minimal() +
  labs(
    title = "Besteedbaar inkomen en vermogen huishoudens",
    y = "(x 1000)",
    x = ''
    ) +
  guides(color = guide_legend(title = '')) +
  scale_color_discrete(labels = c('Besteedbaar inkomen','Mediaan Vermogen'))

rm(df_vermogen)

```


```{r}


```

Regressie gdp, huisprijzen en inkomen (stap 1)

We vinden een zeer sterke correlatie tussen inkomen, werkgelegenheid en huizenprijzen. De verwachting is dat dit met name wordt veroorzaakt door de tijdswaarde. Over de jaren heen, stijgt het inkomen, daalt de rente,  en stijgen de huizenprijzen.

```{r}

# GDP is een percentuele increase per periode (jaar?)
# Ik tel deze nu eerst cumulatief op

df <- 
  prijsindex_woningen_lt %>% 
  full_join (inkomen_lt, by = c('date')) %>% 
  full_join (werkgelegenheid_lt, by = c('date')) %>% 
  full_join (gdp_lt, by = c('date')) %>% 
  full_join (hypotheek_rente_q, by = c('date')) %>% 
  full_join (consumenten_vertrouwen_lt_q, by = c('date')) %>% 
  drop_na() %>% 
  select (date, huisprijsindex, inkomen, werkgelegenheid, gdp_index, consumer_conf)  

# Recalculate inkomen naar inkomenindex (2015 = 100)
dfi <- 
  df %>% 
  filter (year(date) == '2015') %>% 
  summarize(result = mean(inkomen))

df <-
  df %>% 
  mutate(inkomenindex = (inkomen / dfi$result) * 100 )  

df %>% 
  ggplot(aes(x = inkomenindex, y = huisprijsindex)) +
  geom_point() +
   geom_smooth(method = "lm")
  
# Inkomen vs huizenprijzen

lm_inkomen = lm(huisprijsindex~inkomenindex, data = df) #Create the linear regression

tab_model(lm_inkomen)

```

Lineair regressie model voor inkomen en prijsindex huizen.

```{r}

# GDP geeft de beste match
df %>% 
  drop_na() %>% 
  ggplot(aes(x = date, y = gdp_index)) +
  geom_line(color = 'steelblue') +
  theme_minimal() +
  labs(
    title = "gdp incremental",
    y = "",
    x = ''
  ) 

lm_gdp = lm(huisprijsindex~gdp_index, data = df)

tab_model(lm_gdp)

df %>% 
  ggplot(aes(x = gdp_index, y = huisprijsindex)) +
  geom_point() +
  geom_smooth(method = "lm")

# Residuals tonen wel nog een patroon - dus er zit meer in de data
df$predicted <- predict(lm_gdp)   # Save the predicted values
df$residuals <- residuals(lm_gdp) # Save the residual values

ggplot(df, aes(x = gdp_index, y = residuals )) +
  geom_point(color = 'red', alpha = 0.5) +
  theme_minimal() +
  labs(
    title = "Residuals GDP Lineair Model",
    y = "Residuals",
    x = 'GDP Index'
  ) 


```

Wanneer het model wordt uitgebreid met consumer confidence, kan marginaal nog een iets hogere correlatie worden gevonden.
Toevoegen van werkgelegenheid of inkomen geeft geen betere resultaten.

```{r}

# Dit is niet goed. Er zit nog duidelijk wel een patroon in de residuals.
lm_gdp2 = lm(huisprijsindex~gdp_index + consumer_conf, data = df) 
#Create a linear regression with a quadratic coefficient
tab_model(lm_gdp2) #Review the results

#Plot the Cooks Distances.
ggplot(lm_gdp2, aes(seq_along(.cooksd), .cooksd)) +
  geom_col(color = 'steelblue') +
  theme_minimal() 
          

# Multiple regressie, wordt de relatie niet heel veel beter van
lm_gdp_wg = lm(huisprijsindex~gdp_index+werkgelegenheid, data = df) 
tab_model(lm_gdp_wg)

# Multiple regressie, wordt de relatie niet heel veel beter van
lm_gdp_ink = lm(huisprijsindex~gdp_index+inkomenindex, data = df) 
tab_model(lm_gdp_ink)

# Plot van de multiple regressie

```

MARS (multivariate adaptive regression splines)

```{r}
library(rsample)   # data splitting 
library(ggplot2)   # plotting
library(earth)     # fit MARS models
library(caret)     # automating the tuning process
# install.packages("vip")
library(vip)       # variable importance
# install.packages("pdp")
library(pdp)       # variable relationships

```

http://uc-r.github.io/mars

```{r}

set.seed(123)
df_split <- initial_split(df, prop = .7, strata = "huisprijsindex")
df_train <- training(df_split)
df_test  <- testing(df_split)

# Much better fit...
mars3 <- mda::mars(df$date, df$huisprijsindex, nk = 7, prune = FALSE)
df %>%
  mutate(predicted = as.vector(mars3$fitted.values)) %>%
  ggplot(aes(date, huisprijsindex)) +
  geom_point(size = 1, alpha = .2) +
  geom_line(aes(y = predicted), size = 1, color = "blue") +
  ggtitle("(D) Three knots")

# Fit a basic MARS model
mars1 <- earth(
  huisprijsindex ~ .,  
  data = df_train   
)

summary(mars1)

plot(mars1, which = 1)

# Fit a basic MARS model
mars2 <- earth(
  huisprijsindex ~ .,  
  data = df_train,
  degree = 2
)

summary(mars2)

plot(mars2, which = 1)

# create a tuning grid
hyper_grid <- expand.grid(
  degree = 1:3, 
  nprune = seq(2, 100, length.out = 10) %>% floor()
  )

head(hyper_grid)

# for reproducibiity
set.seed(123)
# cross validated model
tuned_mars <- train(
  x = subset(df_train, select = -huisprijsindex),
  y = df_train$huisprijsindex,
  method = "earth",
  metric = "RMSE",
  trControl = trainControl(method = "cv", number = 10),
  tuneGrid = hyper_grid
)

# best model
tuned_mars$bestTune
##    nprune degree
## 14     34      2

# plot results
ggplot(tuned_mars)

# multiple regression
set.seed(123)
cv_model1 <- train(
  huisprijsindex ~ ., 
  data = df_train, 
  method = "lm",
  metric = "RMSE",
  trControl = trainControl(method = "cv", number = 10),
  preProcess = c("zv", "center", "scale")
  )
# principal component regression
set.seed(123)
cv_model2 <- train(
  huisprijsindex ~ ., 
  data = df_train, 
  method = "pcr",
  trControl = trainControl(method = "cv", number = 10),
  metric = "RMSE",
  preProcess = c("zv", "center", "scale"),
  tuneLength = 20
  )

# partial least squares regression
set.seed(123)
cv_model3 <- train(
  huisprijsindex ~ ., 
  data = df_train, 
  method = "pls",
  trControl = trainControl(method = "cv", number = 10),
  metric = "RMSE",
  preProcess = c("zv", "center", "scale"),
  tuneLength = 20
  )

# regularized regression
set.seed(123)
cv_model4 <- train(
  huisprijsindex ~ ., 
  data = df_train,
  method = "glmnet",
  trControl = trainControl(method = "cv", number = 10),
  metric = "RMSE",
  preProcess = c("zv", "center", "scale"),
  tuneLength = 10
)

# Dit geeft niets terug
# extract out of sample performance measures
summary(resamples(list(
  Multiple_regression = cv_model1, 
  PCR = cv_model2, 
  PLS = cv_model3,
  Elastic_net = cv_model4,
  MARS = tuned_mars
  )))$statistics$RMSE %>%
  kableExtra::kable() %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"))


# variable importance plots
p1 <- vip(tuned_mars, num_features = 5, bar = FALSE, value = "gcv") + ggtitle("GCV")
p2 <- vip(tuned_mars, num_features = 5, bar = FALSE, value = "rss") + ggtitle("RSS")
gridExtra::grid.arrange(p1, p2, ncol = 2)

coef(tuned_mars$finalModel) %>%
  tidy() %>%
  dplyr::filter(stringr::str_detect(names, "\\*"))


```


Financiering huizen (inleg eigen geld)

Nog altijd een groot deel van de woonhuizen in Nederland wordt gefinancieerd met een hypotheek.
Welk deel wordt gefinancieerd met overwaarde - of inleg eigen geld?



gegevens per maand, per regio 

--- evt. prognose nieuwbouw toevoegen ---

Bouwkosten

De prijzen van nieuwbouw zijn ten opzichte van bestaande woningen de laatste tijd harder gestegen. Een belangrijke factor hiervoor zouden de bouwkosten zijn.

* _Beschikbaarheid bouwlocaties_
* _Ruimtelijke ordeningbeleid_

### Regionale verschillen

Er bestaan grote regionale verschillen in huisprijzen, en in de prijsonwikkeling over de tijd.

```{r}


# Create a thematic map

verkoopprijs_regio$jaar <- format(verkoopprijs_regio$date, '%Y')

verkoopprijs_regio %>%
  filter(date >= as.Date('2015-01-01')
           ) %>% 
  mutate(verkoopprijs = verkoopprijs / 1000) %>% 
  ggplot() +
  geom_sf(aes(fill = verkoopprijs)) +
  facet_wrap(~jaar) +
  scale_fill_viridis_c(option = "inferno") +
  labs(title = "Gemiddelde verkoopprijzen woningen", 
       subtitle = "",
       fill = "(x 1000 eur)") +
  theme_void()

```





## Aantal transacties

Het aantal transacties heeft inde crisis jaren 2009 - 2012 een duidelijke terugval laten zien. Sindsdien zien we een snele inhaalbeweging, en nog steeds zien we aanzienlijk hogere transactie volumes dan voorheen.

```{r}
verkochte_woningen_per_type_per_kwartaal %>% 
  mutate(subtype = factor(subtype, levels=c('Vrijstaande woning',
                                  '2-onder-1-kapwoning',
                                  'Hoekwoning',
                                  'Tussenwoning',
                                  'Appartement',
                                  'Onbekend'))) %>% 
  ggplot(aes(x=date, y=verkochte_bestaande_woningen )) +
  geom_line(aes(color = subtype)) +
  theme_minimal() +
  facet_wrap(~ subtype, ncol = 2, scales = "free") +
  labs(
    title = "Verkopen Bestaande Koopwoningen per kwartaal",
    y = "",
    x = '',
    color = 'subtype'
    ) +
  theme(legend.position = "none") 
```

Wanneer we kijken naar het aantal transacties valt verder de piek op in apartementen op in Q4 2020. Dit is te verklaren door de wijziging in de regelgeving voor beleggers. Particuliere beleggens op de woningmarkt moeten vanaf 2021 8% overdrachtsbelasting betalen. Dit heeft gezorgt voor een piek aan aankopen in het laatste kwartaal van 2020.

Seizoensinvloeden bij het aantal transacties

Om de seizoensinvloeden verder te analyseren heb ik een tijdreeksanalyse uitgevoerd op de data.
De ACf (auto correlatie) plot toont dat meer recente data significant is, wat een trend aangeeft in de data. De PACF plot (partial auto-correlation function) toont dat recente data en seizoensinvloeden een goede indicatie geven voor het modeleren van de trend.

De uiteindelijke voorspelling heeft niet veel meer waarde dan we hier op het blote oog uit kunnen halen. Bovendien worden recente trends doorgetrokken - waar op termijn juist een terugkeer naar een meer stabiel aantal transacties zou mogen worden verwacht.


```{r}

vw <- verkochte_woningen_per_type_per_kwartaal %>% 
  group_by (yearqtr) %>% 
  summarise(totaal = sum(verkochte_bestaande_woningen) / 1000 )

# Time series object
vwts <- ts(vw["totaal"], 
              start = c(1995, 1), frequency = 4)

v1 <- 
  vwts %>%
  autoplot() +
  geom_smooth() +
  theme_minimal() +
  labs(
    title = "Verkopen Bestaande Koopwoningen per kwartaal",
    y = "(x 1000)",
    x = ''
    ) 

v2 <- 
  vwts %>% 
  ggsubseriesplot() +
  theme_minimal() +
  labs(
    title = "",
    y = "(x 1000)",
    x = ''
    ) 

# Plot it
cowplot::plot_grid(v1, v2, ncol=1, rel_heights = c(1, 1.5))

# Lag plot of non-seasonal effects
gglagplot(vwts, do.lines = FALSE) +
  labs(
    title = "Lagpolt seizoensinvloeden Verkopen Bestaande Koopwoningen",
    y = "",
    x = '',
    color = 'Quarter'
    ) 

# ACF plot
# Visualizes how much the most recent value of the series is correlated with past values of the series
o1 <- ggAcf(vwts, lag.max = 16) +
  labs(
    title = "ACF Plot seizoensinvloeden Verkopen Bestaande Koopwoningen",
    y = "",
    x = ""
    ) 

# PACF Plot
# Visualizes whether certain lags are good for modeling or not; useful for data with a seasonal pattern
o2 <- ggPacf(vwts, lag.max = 16) +
  labs(
    title = "PACF Plot seizoensinvloeden Verkopen Bestaande Koopwoningen",
    y = "",
    x = ""
    ) 

# Plot both
cowplot::plot_grid(o1, o2, ncol = 1)

# Take first difference of the plot + seseonal effects

vwts %>% diff(lag=4) %>% diff() %>% ggtsdisplay(main = "Eerst orde verschil en seizoensinvloed")

# Eventualy I got this model - which seems to fit beter then auto arima
fit <-
  Arima(vwts, order=c(0,1,4), seasonal=c(0,1,1))
checkresiduals(fit)

fit %>% forecast(h=12) %>% autoplot() +
  theme_minimal() +
  labs(
    title = "Verwachting verkopen bestaande koopwoningen",
    y = "",
    x = ""
    ) 

```
  

```{r}
# aanbod_huizen %>%
#   filter(set == "Totaal") %>%
#   ggplot(aes(x=datum )) +
#   geom_line(aes(y=vraagprijs)) +
#   theme(legend.position = "bottom") +
#   labs(title = "Vraagprijs woningen")
```

```{r}
# aanbod_huizen %>%
#   filter(set != "Totaal") %>%
#   ggplot(aes(x=datum )) +
#   geom_line(aes(y=aantal, color = set)) +
#   theme(legend.position = "bottom")
```


```{r}
# aanbod_huizen %>%
#   filter(type != "Totaal") %>%
#   ggplot(aes(x=datum )) +
#   geom_line(aes(y=aanbodtijd, color = set)) +
#   theme(legend.position = "bottom")
```


```{r}
# hypotheek_rente  %>%
#   ggplot(aes(x=period, y = mortgage_interest )) +
#   geom_line()
```


<!-- ```{r} -->
<!-- transacties_per_type %>% -->
<!--   ggplot(aes(x=monthly , y=aantal_verkocht, color= type_woning, fill = type_woning)) + -->
<!--   geom_bar(stat="identity") + -->
<!--   theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "bottom") + -->
<!--   labs(x = "", y = "", title = "Aantal verkocht per type") -->
<!-- ``` -->


# Conclusies

 Deze is ook leuk:

 https://www.youtube.com/watch?v=5UvrPO4eY5A&feature=emb_logo
 
# Referenties
